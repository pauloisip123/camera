<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Barcode Logger</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); padding: 15px; display: flex; flex-direction: column; align-items: center; color: var(--text); }
        
        .container { width: 100%; max-width: 500px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; margin-bottom: 15px; }
        
        .stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9em; }
        .status-dot { color: #10b981; font-weight: bold; }
        
        .history-section { width: 100%; margin-top: 10px; }
        .table-wrapper { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 0.85em; }
        th { background: #f8fafc; position: sticky; top: 0; color: #64748b; }
        
        .btn-clear { background: #fee2e2; color: #ef4444; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
        
        #toast { 
            position: fixed; top: 20px; background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; 
            border-radius: 50px; font-size: 0.85em; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="toast">Duplicate!</div>

    <div class="container">
        <h3 style="margin-top:0;">Barcode Archive</h3>
        
        <div class="stats">
            <span id="status" class="status-dot">● System Online</span>
            <button class="btn-clear" onclick="clearData()">Reset All</button>
        </div>

        <div id="reader"></div>

        <div class="history-section">
            <div style="display:flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                <p style="margin: 0; font-size: 0.85em; color: #64748b;">Unique Items: <b id="count" style="color:var(--primary)">0</b></p>
                <span style="font-size: 0.7em; color: #94a3b8;">Auto-saved to device</span>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Oras</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="scan-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <audio id="beep" src="https://www.soundjay.com/buttons/beep-07a.wav" preload="auto"></audio>

    <script>
        // 1. Load data mula sa localStorage (kung meron)
        let savedScans = JSON.parse(localStorage.getItem('myBarcodes')) || [];
        const scanList = document.getElementById('scan-list');
        const countDisplay = document.getElementById('count');
        const beep = document.getElementById('beep');
        const toast = document.getElementById('toast');

        // I-display ang lumang data pag-load
        function init() {
            renderTable();
            startScanner();
        }

        async function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 150 } };

            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    config, 
                    (decodedText) => {
                        // Check kung exist na sa array
                        const isDuplicate = savedScans.some(item => item.content === decodedText);
                        
                        if (isDuplicate) {
                            showToast("Duplicate ignored");
                        } else {
                            saveNewScan(decodedText);
                        }
                    }
                );
            } catch (err) {
                document.getElementById('status').innerText = "● Camera Error";
                document.getElementById('status').style.color = "red";
            }
        }

        function saveNewScan(content) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const newEntry = { time: timeStr, content: content };
            
            // I-add sa unahan ng array
            savedScans.unshift(newEntry);
            
            // 2. I-save sa LocalStorage
            localStorage.setItem('myBarcodes', JSON.stringify(savedScans));
            
            beep.play();
            if (navigator.vibrate) navigator.vibrate(100);
            
            renderTable();
        }

        function renderTable() {
            scanList.innerHTML = savedScans.map(item => `
                <tr>
                    <td>${item.time}</td>
                    <td style="word-break: break-all;"><b>${item.content}</b></td>
                </tr>
            `).join('');
            countDisplay.innerText = savedScans.length;
        }

        function showToast(msg) {
            toast.innerText = msg;
            toast.style.opacity = "1";
            setTimeout(() => { toast.style.opacity = "0"; }, 1500);
        }

        function clearData() {
            if(confirm("Sigurado ka bang buburahin lahat ng records?")) {
                localStorage.removeItem('myBarcodes');
                savedScans = [];
                renderTable();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
