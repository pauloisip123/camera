<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Barcode Sync</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #0f9d58; --bg: #f1f3f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 450px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .status-box { padding: 10px; margin-bottom: 10px; border-radius: 6px; font-size: 0.85em; text-align: center; font-weight: bold; }
        .syncing { background: #e8f0fe; color: #1967d2; }
        .success { background: #e6fffa; color: #047481; }
        .error { background: #fff5f5; color: #c53030; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 10px; }
        .history-table td { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="container">
        <h3 style="margin:0 0 15px 0; color: #3c4043;">Google Sheets Sync</h3>
        
        <div id="sync-status" class="status-box" style="display:none;">Ready</div>
        
        <div id="reader"></div>

        <div style="font-size: 0.9em; color: #5f6368;">
            <b>Live Records (10-Digits):</b>
            <table class="history-table">
                <tbody id="scan-list"></tbody>
            </table>
        </div>
    </div>

    <audio id="beep" src="https://www.soundjay.com/buttons/beep-07a.wav" preload="auto"></audio>

    <script>
        // --- ILAGAY DITO ANG IYONG GOOGLE WEB APP URL ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjPxm39C55l8qdrH3r-AVugT2d78YLnnLkuzo9MQFb9UA6mpRfSf2hJ93sPTm5Ue83Fg/exec';
        
        const scanList = document.getElementById('scan-list');
        const syncStatus = document.getElementById('sync-status');
        const beep = document.getElementById('beep');
        let isSyncing = false;

        async function startScanner() {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 15, qrbox: { width: 250, height: 150 } };

            try {
                await html5QrCode.start(
                    { facingMode: "environment" }, config, 
                    (decodedText) => {
                        // 10 Digits Only Validation
                        if (/^\d{10}$/.test(decodedText) && !isSyncing) {
                            sendToGoogleSheets(decodedText);
                        }
                    }
                );
            } catch (err) { console.error(err); }
        }

        async function sendToGoogleSheets(barcode) {
            isSyncing = true;
            updateStatus("Sinasave sa Google Sheets...", "syncing");

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors", // Required para sa Google Apps Script
                    cache: "no-cache",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ barcode: barcode })
                });

                // Dahil "no-cors", hindi natin mababasa ang response body, 
                // pero basta walang error sa fetch, assume nating pumasok.
                
                beep.play();
                addToUI(barcode);
                updateStatus("Success! Na-save na.", "success");
                
                // Pause sandali bago payagan ang susunod na scan para iwas duplicate
                setTimeout(() => { 
                    isSyncing = false; 
                    updateStatus("Hinghihintay ng bagong scan...", ""); 
                }, 3000);

            } catch (error) {
                updateStatus("Error sa pag-save!", "error");
                isSyncing = false;
            }
        }

        function addToUI(code) {
            const row = `<tr><td>${new Date().toLocaleTimeString()}</td><td><b>${code}</b></td><td>âœ… Sent</td></tr>`;
            scanList.insertAdjacentHTML('afterbegin', row);
        }

        function updateStatus(msg, className) {
            syncStatus.style.display = "block";
            syncStatus.innerText = msg;
            syncStatus.className = "status-box " + className;
        }

        window.onload = startScanner;
    </script>
</body>
</html>
